-----------------------------------------------------------------------------
--  DATABASE SCHEMA
--
--  TABLE SWM_ROLE
--  Role's table
--
--  TABLE SWM_RESOURCE
--  Resource's table
--
--  TABLE SWM_USER_STATES
--  States for users
--
--  TABLE SWM_USER
--  User's table
--
--  TABLE SWM_USER_ROLE
--  Relationship between users and its roles
--
--  TABLE SWM_CONN_IDENTIFIERS
--  Connection identifiers
--
--  TABLE SWM_CONNECTION_TYPES
--  Connection types table
--
--  TABLE SWM_CONN_TYPE_FIELDS
--  Connection types fields
--
--  TABLE SWM_USER_CONNECTIONS
--  User connection stored
--
--  TABLE SWM_USER_CONN_DETAILS
--  Details connection stored
--
-----------------------------------------------------------------------------

-- TABLE SWM_ROLE
CREATE TABLE SWM_ROLE
(
    ROLE_ID              DECIMAL(2,0)            NOT NULL,
    ROLE_NAME            VARCHAR(100)            NOT NULL,
    STATE                CHAR(1)                 NOT NULL,
    RECORD_DATE          DATETIME                NOT NULL
);

ALTER TABLE SWM_ROLE ADD CONSTRAINT SWM_ROLE_PK
PRIMARY KEY (ROLE_ID);

ALTER TABLE SWM_ROLE ADD CONSTRAINT SWM_ROLE_STATE_CK
CHECK (STATE IN ('A', 'I'));

ALTER TABLE SWM_ROLE ADD CONSTRAINT SWM_ROLE_DF_RECORD_DATE
DEFAULT (getdate()) FOR RECORD_DATE;

-- TABLE SWM_RESOURCE
CREATE TABLE SWM_RESOURCE
(
    RESOURCE_ID          DECIMAL(2,0)            NOT NULL,
    RESOURCE_NAME        VARCHAR(100)            NOT NULL,
    STATE                CHAR(1)                 NOT NULL,
    RECORD_DATE          DATETIME                NOT NULL
);

ALTER TABLE SWM_RESOURCE ADD CONSTRAINT SWM_RESOURCE_PK
PRIMARY KEY (RESOURCE_ID);

ALTER TABLE SWM_RESOURCE ADD CONSTRAINT SWM_RESOURCE_STATE_CK
CHECK (STATE IN ('A', 'I'));

ALTER TABLE SWM_RESOURCE ADD CONSTRAINT SWM_RESOURCE_DF_RECORD_DATE
DEFAULT (getdate()) FOR RECORD_DATE;

-- TABLE SWM_USER_STATES
CREATE TABLE SWM_USER_STATES
(
    USER_STATE_ID        DECIMAL(2,0)            NOT NULL,
    DESCRIPTION          VARCHAR(100)            NOT NULL
);

ALTER TABLE SWM_USER_STATES ADD CONSTRAINT SWM_USER_STATES_PK
PRIMARY KEY (USER_STATE_ID);

-- TABLE SWM_USER
CREATE TABLE SWM_USER
(
    USER_ID              DECIMAL(4,0)            NOT NULL,
    USERNAME             VARCHAR(20)             NOT NULL,
    USER_STATE_ID        DECIMAL(2,0)            NOT NULL,
    USER_PASSWORD        VARCHAR(60)             NOT NULL,
    EMAIL                VARCHAR(50)             NOT NULL,
    TOKEN                VARCHAR(30)             NULL,
    RECORD_DATE          DATETIME                NOT NULL
);

ALTER TABLE SWM_USER ADD CONSTRAINT SWM_USER_PK
PRIMARY KEY (USER_ID);

ALTER TABLE SWM_USER ADD CONSTRAINT SWM_USER_UNIQUE
UNIQUE (USERNAME);

ALTER TABLE SWM_USER ADD CONSTRAINT SWM_USRS_FK_STATE
FOREIGN KEY (USER_STATE_ID) REFERENCES SWM_USER_STATES (USER_STATE_ID);

ALTER TABLE SWM_USER ADD CONSTRAINT SWM_USER_DF_RECORD_DATE
DEFAULT (getdate()) FOR RECORD_DATE;

-- TABLE SWM_USER_ROLE
CREATE TABLE SWM_USER_ROLE
(
    USER_ID              DECIMAL(4,0)            NOT NULL,
    ROLE_ID              DECIMAL(2,0)            NOT NULL
);

ALTER TABLE SWM_USER_ROLE ADD CONSTRAINT SWM_USER_ROLE_PK
PRIMARY KEY (USER_ID, ROLE_ID);

ALTER TABLE SWM_USER_ROLE ADD CONSTRAINT SWM_USR_ROLE_FK_USER_ID
FOREIGN KEY (USER_ID) REFERENCES SWM_USER (USER_ID);

ALTER TABLE SWM_USER_ROLE ADD CONSTRAINT SWM_USR_ROLE_FK_ROLE_ID
FOREIGN KEY (ROLE_ID) REFERENCES SWM_ROLE (ROLE_ID);

-- TABLE SWM_DB_USER_ROLE
-- When authentication is through db, username is not in SWM_USER
CREATE TABLE SWM_DB_USER_ROLE
(
    USERNAME             VARCHAR(30)             NOT NULL,
    ROLE_ID              DECIMAL(2,0)            NOT NULL
);

ALTER TABLE SWM_DB_USER_ROLE ADD CONSTRAINT SWM_DB_USR_ROLE_PK
PRIMARY KEY (USERNAME, ROLE_ID);

ALTER TABLE SWM_DB_USER_ROLE ADD CONSTRAINT SWM_DB_USR_ROLE_FK_ROLE_ID
FOREIGN KEY (ROLE_ID) REFERENCES SWM_ROLE (ROLE_ID);


-- BASIC DATA
INSERT INTO SWM_USER_STATES (USER_STATE_ID, DESCRIPTION) VALUES (1, 'Pending email');
INSERT INTO SWM_USER_STATES (USER_STATE_ID, DESCRIPTION) VALUES (2, 'Active');


-- TABLE SWM_CONN_IDENTIFIERS
CREATE TABLE SWM_CONN_IDENTIFIERS
(
    CONN_IDENTI_ID       DECIMAL(2,0)            NOT NULL,
    CONN_IDENTI_NAME     VARCHAR(6)              NOT NULL
);

ALTER TABLE SWM_CONN_IDENTIFIERS ADD CONSTRAINT SWM_CONN_IDENTIFIERS_PK
PRIMARY KEY (CONN_IDENTI_ID);

-- TABLE SWM_CONNECTION_TYPES
CREATE TABLE SWM_CONNECTION_TYPES
(
    CONN_TYPE_ID         DECIMAL(3,0)            NOT NULL,
    CONN_TYPE_NAME       VARCHAR(20)             NOT NULL
);

ALTER TABLE SWM_CONNECTION_TYPES ADD CONSTRAINT SWM_CONNECTION_TYPES_PK
PRIMARY KEY (CONN_TYPE_ID);

-- TABLE SWM_CONN_TYPE_FIELDS
CREATE TABLE SWM_CONN_TYPE_FIELDS
(
    CONN_TYPE_ID         DECIMAL(3,0)            NOT NULL,
    CONN_IDENTI_ID       DECIMAL(2,0)            NOT NULL,
    FIELD_NAME           VARCHAR(20)             NOT NULL,
    PLACEHOLDER          VARCHAR(60)             NULL
);

ALTER TABLE SWM_CONN_TYPE_FIELDS ADD CONSTRAINT SWM_CONN_TYPE_FIELDS_PK
PRIMARY KEY (CONN_TYPE_ID, CONN_IDENTI_ID);

ALTER TABLE SWM_CONN_TYPE_FIELDS ADD CONSTRAINT SWM_CONN_TYPE_FIELDS_FK_TYPE
FOREIGN KEY (CONN_TYPE_ID) REFERENCES SWM_CONNECTION_TYPES (CONN_TYPE_ID);

ALTER TABLE SWM_CONN_TYPE_FIELDS ADD CONSTRAINT SWM_CONN_TYPE_FIELDS_FK_IDENTI
FOREIGN KEY (CONN_IDENTI_ID) REFERENCES SWM_CONN_IDENTIFIERS (CONN_IDENTI_ID);

-- TABLE SWM_USER_CONNECTIONS
CREATE TABLE SWM_USER_CONNECTIONS
(
    USER_CONN_ID         DECIMAL(6,0)            NOT NULL,
    CONN_TYPE_ID         DECIMAL(3,0)            NOT NULL,
    USER_ID              DECIMAL(4,0)            NOT NULL,
    CONNECTION_NAME      VARCHAR(100)            NOT NULL,
    STATE                CHAR(1)                 NOT NULL,
    RECORD_DATE          DATETIME                NOT NULL
);

ALTER TABLE SWM_USER_CONNECTIONS ADD CONSTRAINT SWM_USER_CONNECTIONS_PK
PRIMARY KEY (USER_CONN_ID);

ALTER TABLE SWM_USER_CONNECTIONS ADD CONSTRAINT SWM_USER_CONNECTIONS_FK_TYPE
FOREIGN KEY (CONN_TYPE_ID) REFERENCES SWM_CONNECTION_TYPES (CONN_TYPE_ID);

ALTER TABLE SWM_USER_CONNECTIONS ADD CONSTRAINT SWM_USER_CONNECTIONS_FK_USER
FOREIGN KEY (USER_ID) REFERENCES SWM_USERS (USER_ID);

ALTER TABLE SWM_USER_CONNECTIONS ADD CONSTRAINT SWM_USER_CONN_DF_RECORD_DATE
DEFAULT (getdate()) FOR RECORD_DATE;

-- TABLE SWM_USER_CONN_DETAILS
CREATE TABLE SWM_USER_CONN_DETAILS
(
    USER_CONN_ID         DECIMAL(6,0)            NOT NULL,
    CONN_IDENTI_ID       DECIMAL(2,0)            NOT NULL,
    FIELD_VALUE          VARCHAR(50)             NULL
);

ALTER TABLE SWM_USER_CONN_DETAILS ADD CONSTRAINT SWM_USER_CONN_DETAILS_PK
PRIMARY KEY (USER_CONN_ID, CONN_IDENTI_ID);

ALTER TABLE SWM_USER_CONN_DETAILS ADD CONSTRAINT SWM_USER_CONN_DET_FK_ID
FOREIGN KEY (USER_CONN_ID) REFERENCES SWM_USER_CONNECTIONS (USER_CONN_ID);


-----------------------------------------------------------------------------
--  BASIC DATA REQUIRED
-----------------------------------------------------------------------------

INSERT INTO SWM_CONN_IDENTIFIERS (CONN_IDENTI_ID, CONN_IDENTI_NAME)
VALUES (1, 'dbhost');

INSERT INTO SWM_CONN_IDENTIFIERS (CONN_IDENTI_ID, CONN_IDENTI_NAME)
VALUES (2, 'dbuser');

INSERT INTO SWM_CONN_IDENTIFIERS (CONN_IDENTI_ID, CONN_IDENTI_NAME)
VALUES (3, 'dbpass');

INSERT INTO SWM_CONN_IDENTIFIERS (CONN_IDENTI_ID, CONN_IDENTI_NAME)
VALUES (4, 'dbname');

INSERT INTO SWM_CONN_IDENTIFIERS (CONN_IDENTI_ID, CONN_IDENTI_NAME)
VALUES (5, 'driver');

INSERT INTO SWM_CONN_IDENTIFIERS (CONN_IDENTI_ID, CONN_IDENTI_NAME)
VALUES (6, 'dbchar');

INSERT INTO SWM_CONN_IDENTIFIERS (CONN_IDENTI_ID, CONN_IDENTI_NAME)
VALUES (7, 'dbport');

INSERT INTO SWM_CONNECTION_TYPES (CONN_TYPE_ID, CONN_TYPE_NAME)
VALUES (1, 'TNS');

INSERT INTO SWM_CONNECTION_TYPES (CONN_TYPE_ID, CONN_TYPE_NAME)
VALUES (2, 'Basic');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (1, 'Alias', 4, 'type the alias in the tns file');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (1, 'User', 2, 'user');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (1, 'Password', 3, 'password');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (1, 'Driver', 5, 'database driver');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (2, 'Host', 1, 'hostname');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (2, 'User', 2, 'user');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (2, 'Password', 3, 'password');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (2, 'Database name', 4, 'the database name');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (2, 'Driver', 5, 'database driver');

INSERT INTO SWM_CONN_TYPE_FIELDS (CONN_TYPE_ID, FIELD_NAME, CONN_IDENTI_ID, PLACEHOLDER)
VALUES (2, 'Port', 7, 'port');

INSERT INTO SWM_ROLE (ROLE_ID, ROLE_NAME, STATE)
VALUES (1, 'Administrator', 'A');

INSERT INTO SWM_ROLE (ROLE_ID, ROLE_NAME, STATE)
VALUES (2, 'Moderator', 'A');

INSERT INTO SWM_ROLE (ROLE_ID, ROLE_NAME, STATE)
VALUES (3, 'Guest', 'A');

INSERT INTO SWM_USER_STATES (USER_STATE_ID, DESCRIPTION)
VALUES (1, 'Pending activation');

INSERT INTO SWM_USER_STATES (USER_STATE_ID, DESCRIPTION)
VALUES (2, 'Actived');

INSERT INTO SWM_USER_STATES (USER_STATE_ID, DESCRIPTION)
VALUES (3, 'Banned');

INSERT INTO SWM_USERS (USER_ID, USERNAME, USER_STATE_ID, ROLE_ID, USER_PASSWORD, EMAIL)
VALUES (1, 'admin', 2, 2, '$2y$10$6b/9w1L5GPdnpXT2NpdNIe/b4SzYJ9gfRaOYP2xUXWbZ3ekR1GyHi', 'admin@localhost');
